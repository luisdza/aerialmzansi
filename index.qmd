---
title: "Mzansi from the air"
filters:
  - lightbox
lightbox: auto
---

```{r generate new image, echo=FALSE}
library(magrittr)

borders <- sf::read_sf("zaf_admbnda_adm0_sadb_ocha_20201109.shp")

test_result <- FALSE
while(!test_result){
  lat <- round(runif(1, -35, -25), 4)
  lon <- round(runif(1, 25, 35), 4)
  rand_pt <- data.frame(lon, lat) 
  rand_pt_sf <- sf::st_as_sf(rand_pt, coords = c("lon", "lat"), crs = "+proj=longlat +datum=WGS84 +no_defs")
  test <- sf::st_intersection(borders$geometry, rand_pt_sf)
  test_result <- any(sf::st_is_valid(test))
}
  
zoom <- 17
# note from https://docs.mapbox.com/help/glossary/zoom-level/
# zoom level 17 corresponds to 1.5 feet/pixel for 512x512
# w*1.5*1.5/ 5280 = 1/3 of a mile wide

scale <- 2.5
w <- 512*scale
h <- 512*scale

img_url <- paste0(
  "https://api.mapbox.com/styles/v1/mapbox/satellite-v9/static/",
  paste0(lon, ",", lat),
  ",",zoom,",0/",w,"x",h,"@2x?access_token=", # first digit on this line is zoom level (between 0 and 22)
  Sys.getenv("MAPBOX_PUBLIC_ACCESS_TOKEN")
  )

image_name <- paste0(as.character(Sys.time(), format = '%Y%m%d_%H%M'),"_",lon,"_",lat,".jpeg")
download.file(img_url, image_name, mode = "wb", quiet = TRUE)
```

```{r upload image to Azure, echo=FALSE}
# Connect to Azure blob
blob_endp_url <- "https://aerialmzansi.blob.core.windows.net/"
endp <- AzureStor::blob_endpoint(blob_endp_url, key=Sys.getenv("AZURE_BLOB_ACCESS_KEY"))

# Select image container
cont <- AzureStor::blob_container(endp, "images")

# Upload image to container
AzureStor::storage_upload(cont, image_name)

```

```{r get list of images from Azure blob, echo=FALSE}
# Image list
blob_image_names <- data.frame(image_name = AzureStor::list_blobs(cont, info="name"))

blob_image_names %>% 
  dplyr::arrange(desc(image_name)) %>% 
  dplyr::mutate(url = paste0(blob_endp_url,"images/",image_name),
                file_name = stringr::str_replace(image_name,".jpeg","")) %>%
  tidyr::separate(file_name, c("date","time","long","lat"), sep = "_") %>% 
  dplyr::mutate(google_maps_url = paste0('https://maps.google.com?q=/@', lat, ',', long)) %>% 
  dplyr::mutate(open_street_maps_url = paste0('https://www.openstreetmap.org/#map=17/', lat, '/', long)) %>% 
  dplyr::mutate(markdown = paste0("![](", url, "){ group=\"'",date,"'\" description=\"[Goolge Maps](", google_maps_url, ") [Open Street Maps](", open_street_maps_url, ") Generated ",date," ",time," \"}")) %>% 
  dplyr::select(markdown) %>% 
  knitr::kable(col.names = "")
```
