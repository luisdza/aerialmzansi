---
title: "index"
---

# Mzansi from the air

```{r generate new image, echo=FALSE}
#usethis::edit_r_environ()
lat <- round(runif(1, -35, -25), 4)
lon <- round(runif(1, 25, 35), 4)
rand_pt <- data.frame(lon, lat) 
rand_pt_sf <- sf::st_as_sf(rand_pt, coords = c("lon", "lat"), crs = "+proj=longlat +datum=WGS84 +no_defs")

zoom <- 17
# note from https://docs.mapbox.com/help/glossary/zoom-level/
# zoom level 17 corresponds to 1.5 feet/pixel for 512x512
# w*1.5*1.5/ 5280 = 1/3 of a mile wide

scale <- 2.5
w <- 512*scale
h <- 512*scale

img_url <- paste0(
  "https://api.mapbox.com/styles/v1/mapbox/satellite-v9/static/",
  paste0(lon, ",", lat),
  ",",zoom,",0/",w,"x",h,"@2x?access_token=", # first digit on this line is zoom level (between 0 and 22)
  Sys.getenv("MAPBOX_PUBLIC_ACCESS_TOKEN")
  )

image_name <- paste0(as.character(Sys.time(), format = '%Y%m%d-%H%M'),".jpeg")
download.file(img_url, image_name, mode = "wb", quiet = TRUE)
```

```{r upload image to Azure, echo=FALSE}
# Connect to Azure blob
endp <- AzureStor::blob_endpoint("https://aerialmzansi.blob.core.windows.net/", key=Sys.getenv("AZURE_BLOB_ACCESS_KEY"))

# Select image container
cont <- AzureStor::blob_container(endp, "images")

# Upload image to container
AzureStor::storage_upload(cont, image_name)

```

```{r get list of images from Azure blob, echo=FALSE}
# Image list
imgs <- dplyr::tibble(ImageName = AzureStor::list_blobs(cont, info="name"))

imgs$ImageName <- sprintf("![](https://aerialmzansi.blob.core.windows.net/images/%s)", imgs$ImageName)

imgs |>
  kableExtra::kable("html", col.names = NULL)
```
